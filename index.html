
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IMC-Selling Hub - Completo</title>
  <style>
    body { font-family: Arial; margin: 0; background: #f4f4f4; }
    header { background: #222; color: white; padding: 20px; text-align: center; }
    .container { max-width: 1200px; margin: 20px auto; background: white; padding: 20px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; padding: 10px; background: #eee; }
    .calendar-day { background: white; border: 1px solid #ccc; padding: 10px; min-height: 60px; position: relative; }
    .calendar-day.has-fatture { border: 2px solid #007bff; background-color: #dceeff; cursor: pointer; }
    .calendar-day .count { position: absolute; top: 2px; right: 4px; font-weight: bold; color: #007bff; }
    .card-grid { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .card { background: #e9ecef; padding: 15px; border-radius: 8px; cursor: pointer; width: calc(50% - 20px); position: relative; }
    .delete-btn { position: absolute; top: 10px; right: 10px; background: red; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    .columns { display: flex; gap: 20px; margin-top: 20px; }
    .column { flex: 1; background: #f9f9f9; padding: 10px; border-radius: 6px; }
    .fattura { background: #fff; border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
    .form-field { margin-bottom: 10px; }
    input, select { padding: 5px; width: 100%; }
    button { padding: 6px 12px; margin-top: 10px; }
    #fattureDelGiorno, #dittaDetails { margin-top: 20px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <header><h1>IMC-Selling Hub</h1></header>

  <div class="container">
    <h2>üìÖ Calendario Scadenze</h2>
    <div><button onclick="cambiaMese(-1)">‚óÄÔ∏è</button> <span id="meseCorrente">Mese</span> <button onclick="cambiaMese(1)">‚ñ∂Ô∏è</button></div>
    <div class="calendar-grid" id="calendarGrid"></div>
    <div id="fattureDelGiorno"></div>
  </div>

  <div class="container" id="homePage">
    <h2>üìã Gestione Ditte</h2>
    <input type="text" id="newDittaInput" placeholder="Nome nuova ditta..."/>
    <button onclick="aggiungiDitta()">‚ûï Aggiungi Ditta</button>
    <div class="card-grid" id="dittaCards"></div>
  </div>

  <div class="container" id="dittaDetails" style="display:none;">
    <button onclick="goBack()">‚Üê Torna alla Home</button>
    <h2 id="titoloDitta">Ditta: ...</h2>
    <div class="form-field"><input id="numero" type="text" placeholder="Numero Fattura"></div>
    <div class="form-field"><input id="data" type="date"></div>
    <div class="form-field"><input id="dare" type="number" placeholder="Importo Dare (‚Ç¨)"></div>
    <div class="form-field"><input id="avere" type="number" placeholder="Importo Avere (‚Ç¨)"></div>
    <div class="form-field"><input id="scadenza" type="text" placeholder="Scadenza (es. 30/04/2025)"></div>
    <div class="form-field"><input id="prestazione" type="text" placeholder="Tipo di lavoro"></div>
    <div class="form-field"><input id="cliente" type="text" placeholder="Cliente"></div>
    <div class="form-field"><input id="note" type="text" placeholder="Note"></div>
    <div class="form-field"><select id="societa"><option value="IMC">IMC</option><option value="SELLING">SELLING</option></select></div>
    <div class="form-field"><select id="stato"><option value="Pagata">Pagata</option><option value="Da pagare">Da pagare</option><option value="In attesa">In attesa</option></select></div>
    <button id="aggiungiFatturaBtn">‚ûï Aggiungi Fattura</button>
    <div class="columns">
      <div class="column" id="colIMC"><h3>IMC</h3></div>
      <div class="column" id="colSELLING"><h3>SELLING</h3></div>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCZ567XxvheXE9PwRuy3eqBuc6Ey6APz94",
  authDomain: "ditte-e-fornitori.firebaseapp.com",
  projectId: "ditte-e-fornitori",
  storageBucket: "ditte-e-fornitori.firebasestorage.app",
  messagingSenderId: "180273712086",
  appId: "1:180273712086:web:e4d108a1a7db6090d4b277"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let meseCorrente = new Date().getMonth();
let annoCorrente = new Date().getFullYear();
let dittaCorrente = null;

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("aggiungiFatturaBtn").addEventListener("click", aggiungiFattura);
  caricaFattureEDitte();
});

function cambiaMese(delta) {
  meseCorrente += delta;
  if (meseCorrente > 11) { meseCorrente = 0; annoCorrente++; }
  else if (meseCorrente < 0) { meseCorrente = 11; annoCorrente--; }
  caricaFattureEDitte();
}

function goBack() {
  document.getElementById("homePage").style.display = "block";
  document.getElementById("dittaDetails").style.display = "none";
}

async function caricaFattureEDitte() {
  const calendario = [];
  const snapshot = await db.collection("ditte").get();
  document.getElementById("dittaCards").innerHTML = "";
  snapshot.forEach(async doc => {
    const nome = doc.id;
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<h3>${nome}</h3><button class="delete-btn" onclick="eliminaDitta(event, '${nome}')">üóëÔ∏è</button>`;
    div.onclick = () => mostraDettaglioDitta(nome);
    document.getElementById("dittaCards").appendChild(div);
    const fattSnap = await db.collection("ditte").doc(nome).collection("fatture").get();
    fattSnap.forEach(f => calendario.push(f.data()));
    generaCalendario(calendario, meseCorrente, annoCorrente);
  });
}

function generaCalendario(fatture, mese, anno) {
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";
  const intestazione = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];
  document.getElementById("meseCorrente").textContent = new Date(anno, mese).toLocaleDateString("it-IT", { month: "long", year: "numeric" }).toUpperCase();
  intestazione.forEach(g => {
    const div = document.createElement("div");
    div.innerHTML = "<strong>" + g + "</strong>";
    grid.appendChild(div);
  });
  const giornoStart = new Date(anno, mese, 1).getDay();
  for (let i = 1; i < (giornoStart === 0 ? 7 : giornoStart); i++) {
    grid.appendChild(document.createElement("div"));
  }
  const giorni = new Date(anno, mese + 1, 0).getDate();
  for (let g = 1; g <= giorni; g++) {
    const dataKey = `${String(g).padStart(2, "0")}/${String(mese + 1).padStart(2, "0")}/${anno}`;
    const box = document.createElement("div");
    box.className = "calendar-day";
    box.textContent = g;
    const eventi = fatture.filter(f => f.data === dataKey);
    if (eventi.length > 0) {
      box.classList.add("has-fatture");
      const totale = eventi.reduce((s, f) => s + parseFloat(f.dare || 0), 0);
      const c = document.createElement("div");
      c.className = "count";
      c.textContent = `${eventi.length} / ‚Ç¨${totale}`;
      box.appendChild(c);
    }
    grid.appendChild(box);
  }
}

async function mostraDettaglioDitta(nome) {
  dittaCorrente = nome;
  document.getElementById("homePage").style.display = "none";
  document.getElementById("dittaDetails").style.display = "block";
  document.getElementById("titoloDitta").textContent = "Ditta: " + nome;
  const snap = await db.collection("ditte").doc(nome).collection("fatture").get();
  document.getElementById("colIMC").innerHTML = "<h3>IMC</h3>";
  document.getElementById("colSELLING").innerHTML = "<h3>SELLING</h3>";
  snap.forEach(doc => {
    const f = doc.data();
    const html = `<div class="fattura"><strong>N¬∞:</strong> ${f.numero}<br/>
      <strong>Data:</strong> ${f.data}<br/>
      <strong>Dare:</strong> ‚Ç¨${f.dare}<br/>
      <strong>Cliente:</strong> ${f.cliente}<br/>
      <strong>Stato:</strong> ${f.stato}</div>`;
    document.getElementById(f.societa === "SELLING" ? "colSELLING" : "colIMC").innerHTML += html;
  });
}

async function aggiungiDitta() {
  const nome = document.getElementById("newDittaInput").value.trim();
  if (!nome) return alert("Inserisci un nome valido.");
  await db.collection("ditte").doc(nome).set({ creata: new Date().toISOString() });
  caricaFattureEDitte();
}

async function eliminaDitta(event, nome) {
  event.stopPropagation();
  if (!confirm("Eliminare " + nome + "?")) return;
  const snap = await db.collection("ditte").doc(nome).collection("fatture").get();
  const batch = db.batch();
  snap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  await db.collection("ditte").doc(nome).delete();
  caricaFattureEDitte();
}

async function aggiungiFattura() {
  const nuova = {
    numero: document.getElementById("numero").value,
    data: document.getElementById("data").value.split("-").reverse().join("/"),
    dare: parseFloat(document.getElementById("dare").value),
    avere: parseFloat(document.getElementById("avere").value),
    scadenza: document.getElementById("scadenza").value,
    prestazione: document.getElementById("prestazione").value,
    cliente: document.getElementById("cliente").value,
    note: document.getElementById("note").value,
    societa: document.getElementById("societa").value,
    stato: document.getElementById("stato").value
  };
  await db.collection("ditte").doc(dittaCorrente).collection("fatture").add(nuova);
  mostraDettaglioDitta(dittaCorrente);
  caricaFattureEDitte();
}
</script>
</body>
</html>
